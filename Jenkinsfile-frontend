pipeline {
  agent {
    kubernetes {
      label 'jenkins-buildah-agent'
      defaultContainer 'buildah'
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: buildah
spec:
  serviceAccountName: jenkins-sa
  containers:
  - name: buildah
    image: quay.io/buildah/stable
    command:
    - cat
    tty: true
    securityContext:
      privileged: true
"""
    }
  }

  environment {
    AWS_REGION     = 'us-east-1'
    ECR_REPO       = '100587526360.dkr.ecr.us-east-1.amazonaws.com/frontend'
    IMAGE_TAG      = "v${env.BUILD_NUMBER}"
    GIT_REPO       = 'https://github.com/MultiCloud-Devops/fullstack-authors-books-application.git'
    GIT_BRANCH     = 'main'
    GIT_USER       = 'MultiCloud-Devops'
    GIT_EMAIL      = 'krishnaurs2022@gmail.com'
  }

  stages {
    stage('Checkout Code') {
      steps {
        git url: "${env.GIT_REPO}", branch: "${env.GIT_BRANCH}"
      }
    }

    stage('Login to ECR') {
      steps {
        container('buildah') {
          sh '''
            aws ecr get-login-password --region ${AWS_REGION} \
              | buildah login --username AWS --password-stdin ${ECR_REPO}
          '''
        }
      }
    }

    stage('Build and Push Image to ECR') {
      steps {
        container('buildah') {
          sh '''
            buildah bud -t ${ECR_REPO}:${IMAGE_TAG} .
            buildah push ${ECR_REPO}:${IMAGE_TAG}
          '''
        }
      }
    }

    stage('Update k8s manifest') {
      steps {
        script {
          sh '''
            sed -i "s|image: ${ECR_REPO}:.*|image: ${ECR_REPO}:${IMAGE_TAG}|" k8s-files/frontend-deploy-service.yml
          '''
        }
      }
    }

    stage('Commit updated manifest') {
      steps {
        script {
          sh '''
            git config --global user.name "${GIT_USER}"
            git config --global user.email "${GIT_EMAIL}"
            git add k8s-files/frontend-deploy-service.yml
            git commit -m "CI: Update image to ${IMAGE_TAG}"
            git push origin ${GIT_BRANCH}
          '''
        }
      }
    }
  }
}
