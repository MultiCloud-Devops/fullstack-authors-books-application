pipeline {
  agent {
    kubernetes {
      label 'buildah-agent'
      defaultContainer 'buildah'
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: buildah
spec:
  serviceAccountName: jenkins-sa  # IRSA-enabled service account
  containers:
  - name: buildah
    image: 100587526360.dkr.ecr.us-east-1.amazonaws.com/buildah-awscli:latest
    securityContext:
      privileged: true
    command:
    - cat
    tty: true
"""
    }
  }

  environment {
    AWS_REGION    = 'us-east-1'
    ECR_REPO      = '100587526360.dkr.ecr.us-east-1.amazonaws.com/frontend'
    IMAGE_TAG     = "v${env.BUILD_NUMBER}"
    GIT_REPO      = 'https://github.com/MultiCloud-Devops/fullstack-authors-books-application.git'
    GIT_BRANCH    = 'main'
    GIT_USER      = 'MultiCloud-Devops'
    GIT_EMAIL     = 'krishnaurs2022@gmail.com'
    DOCKERFILE    = 'frontend/Dockerfile'
    CONTEXT_DIR   = 'frontend'
    K8S_YAML      = 'k8s-files/frontend-deploy-service.yml'
  }

  stages {
    stage('Checkout Code') {
      steps {
        checkout([$class: 'GitSCM',
          branches: [[name: "*/${env.GIT_BRANCH}"]],
          userRemoteConfigs: [[url: "${env.GIT_REPO}"]]
        ])
      }
    }

    stage('Login to ECR') {
      steps {
        container('buildah') {
          sh '''
            aws --region $AWS_REGION ecr get-login-password | \
              buildah login --username AWS --password-stdin $ECR_REPO
          '''
        }
      }
    }

    stage('Build and Push Image to ECR') {
      steps {
        container('buildah') {
          sh '''
            buildah bud -f $DOCKERFILE -t $ECR_REPO:$IMAGE_TAG $CONTEXT_DIR
            buildah push $ECR_REPO:$IMAGE_TAG
          '''
        }
      }
    }

    stage('Update k8s manifest') {
      steps {
        sh '''
          sed -i "s|image: $ECR_REPO:.*|image: $ECR_REPO:$IMAGE_TAG|" $K8S_YAML
        '''
      }
    }

    stage('Commit updated manifest') {
      steps {
        sh '''
          git config --global user.name "$GIT_USER"
          git config --global user.email "$GIT_EMAIL"
          git add $K8S_YAML
          git commit -m "CI: Update frontend image to $IMAGE_TAG"
          git push origin $GIT_BRANCH
        '''
      }
    }
  }
}
