pipeline {
  agent {
    kubernetes {
      label 'jenkins-kaniko-agent'
      defaultContainer 'kaniko'
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: kaniko
spec:
  serviceAccountName: jenkins-sa
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    args:
      - --dockerfile=Dockerfile
      - --context=.
      - --destination=100587526360.dkr.ecr.us-east-1.amazonaws.com/frontend:v\$(BUILD_NUMBER)
      - --verbosity=info
    volumeMounts:
      - name: kaniko-secret
        mountPath: /kaniko/.docker
  restartPolicy: Never
  volumes:
  - name: kaniko-secret
    projected:
      sources:
      - serviceAccountToken:
          path: token
"""
    }
  }

  environment {
    AWS_REGION = 'us-east-1'
    ECR_REPO   = '100587526360.dkr.ecr.us-east-1.amazonaws.com/frontend'
    IMAGE_TAG  = "v${env.BUILD_NUMBER}"
  }

  stages {
    stage('Checkout') {
      steps {
        git url: 'https://github.com/MultiCloud-Devops/fullstack-authors-books-application.git', branch: 'main'
      }
    }

    stage('Build & Push') {
      steps {
        container('kaniko') {
          echo "Kaniko build running automatically from args in pod YAML."
          // No shell step needed here â€” Kaniko runs from args
        }
      }
    }
  }
}
