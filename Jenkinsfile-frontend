pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: buildah
spec:
  containers:
  - name: buildah
    image: 100587526360.dkr.ecr.us-east-1.amazonaws.com/buildah-awscli:latest
    command:
    - cat
    tty: true
    securityContext:
      privileged: true
  serviceAccountName: jenkins-sa
"""
    }
  }

  environment {
    AWS_REGION = "us-east-1"
    IMAGE_REPO = "100587526360.dkr.ecr.us-east-1.amazonaws.com/frontend"
    IMAGE_TAG = "latest"
  }

  stages {
    stage('Checkout Code') {
      steps {
        container('buildah') {
          git 'https://github.com/MultiCloud-Devops/fullstack-authors-books-application.git'
        }
      }
    }

    stage('Login to ECR') {
      steps {
        container('buildah') {
          sh '''
            aws --version
            aws ecr get-login-password --region $AWS_REGION | buildah login --username AWS --password-stdin $IMAGE_REPO
          '''
        }
      }
    }

    stage('Build and Push Image to ECR') {
      steps {
        container('buildah') {
          sh '''
            buildah bud -t $IMAGE_REPO:$IMAGE_TAG frontend
            buildah push $IMAGE_REPO:$IMAGE_TAG
          '''
        }
      }
    }

    stage('Update k8s manifest') {
      steps {
        container('buildah') {
          sh '''
            sed -i "s|image:.*|image: $IMAGE_REPO:$IMAGE_TAG|" manifests/frontend-deployment.yaml
          '''
        }
      }
    }

    stage('Commit updated manifest') {
      steps {
        container('buildah') {
          withCredentials([gitUsernamePassword(credentialsId: 'your-git-creds-id')]) {
            sh '''
              git config user.name "jenkins"
              git config user.email "jenkins@example.com"
              git add manifests/frontend-deployment.yaml
              git commit -m "Updated image tag to $IMAGE_TAG"
              git push origin main
            '''
          }
        }
      }
    }
  }
}
